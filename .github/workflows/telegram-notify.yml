name: Telegram Notification on Issue

on:
  issues:
    types: [opened]

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Issue Data
        id: issue
        run: |
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT

      - name: Format Telegram Message
        id: format
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `${{ github.event.issue.body }}`;
            
            // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Markdown
            const nameMatch = body.match(/\*\*üë§ –ò–º—è:\*\*\s*(.+)/);
            const phoneMatch = body.match(/\*\*üìû –¢–µ–ª–µ—Ñ–æ–Ω:\*\*\s*(.+)/);
            const serviceMatch = body.match(/\*\*üíÖ –£—Å–ª—É–≥–∞:\*\*\s*(.+)/);
            const datetimeMatch = body.match(/\*\*üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:\*\*\s*(.+)/);
            const commentMatch = body.match(/\*\*üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:\*\*\s*([\s\S]+?)(?=\*\*|$)/);
            
            const name = nameMatch ? nameMatch[1].trim() : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const phone = phoneMatch ? phoneMatch[1].trim() : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const service = serviceMatch ? serviceMatch[1].trim() : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const datetime = datetimeMatch ? datetimeMatch[1].trim() : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const comment = commentMatch ? commentMatch[1].trim() : '';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
            let message = `üü£ –ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨ #${{ github.event.issue.number }} üü£%0A%0A`;
            message += `üë§ –ò–º—è: ${encodeURIComponent(name)}%0A`;
            message += `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${encodeURIComponent(phone)}%0A`;
            message += `üíÖ –£—Å–ª—É–≥–∞: ${encodeURIComponent(service)}%0A`;
            message += `üìÖ –î–∞—Ç–∞: ${encodeURIComponent(datetime)}%0A`;
            
            if (comment) {
              message += `%0Aüí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${encodeURIComponent(comment)}%0A`;
            }
            
            message += `%0Aüîó –°—Å—ã–ª–∫–∞: ${{ github.event.issue.html_url }}`;
            
            core.setOutput('message', message);

      - name: Send to Telegram
        run: |
          MESSAGE="${{ steps.format.outputs.message }}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=false"

      - name: Add Labels
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['–∑–∞–ø–∏—Å—å', '–Ω–æ–≤–æ–µ']
            })

      - name: Comment on Issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!'
            })


